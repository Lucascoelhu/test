<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Planograma Mobile</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
    :root {
        --primary: #2c3e50;
        --accent: #e67e22;
        --bg: #ecf0f1;
        --gondola-bg: #fff;
        --shelf-border: #95a5a6;
        --header-h: 50px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg); 
        margin: 0; padding: 0; 
        height: 100dvh; 
        width: 100vw;
        overflow: hidden; /* Mantido para controlar o layout principal */
        display: flex; flex-direction: column;
    }

    /* --- Header (Fixo no topo) --- */
    header {
        height: var(--header-h);
        background: var(--primary); color: white; padding: 0 15px;
        display: flex; justify-content: space-between; align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        flex: 0 0 auto; 
        z-index: 10;
    }
    h1 { margin: 0; font-size: 1rem; font-weight: 600; display: flex; flex-direction: column; }
    .credits { font-size: 10px; font-weight: normal; opacity: 0.7; margin-top: 2px; color: #bdc3c7; }

    .header-btns button {
        background: rgba(255,255,255,0.2); border: none; color: white;
        padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-left:5px;
        transition: background 0.2s;
    }
    .header-btns button:hover { background: rgba(255,255,255,0.3); }

    /* --- Corredor (Ocupa todo o espa√ßo do meio) --- */
    #aisle-container {
        flex: 1 1 auto; 
        display: flex; 
        flex-direction: row;
        overflow-x: auto; 
        overflow-y: hidden; 
        padding: 10px;
        gap: 8px;
        align-items: flex-start;
        background-image: linear-gradient(#ddd 1px, transparent 1px);
        background-size: 20px 20px;
    }

    /* --- G√¥ndola --- */
    .gondola {
        background: var(--gondola-bg);
        width: 340px; 
        min-width: 340px;
        height: 100%; 
        border: 1px solid #bdc3c7;
        border-top: 6px solid #7f8c8d; 
        display: flex; flex-direction: column;
        box-shadow: 3px 0 8px rgba(0,0,0,0.1);
        border-radius: 4px 4px 0 0;
        position: relative;
    }
    
    .gondola-header {
        text-align: center; font-size: 12px; color: #fff; 
        background: #7f8c8d; padding: 6px;
        display: flex; justify-content: space-between; align-items: center;
        font-weight: bold; flex: 0 0 auto;
    }
    .btn-del-gondola { background:none; border:none; color:#ffcfcf; font-weight:bold; font-size:16px; padding:0 5px;}

    /* √Årea das prateleiras: Scroll interno se precisar */
    .shelf-area {
        flex: 1 1 auto; 
        overflow-y: auto; 
        padding: 5px 0;
        display: flex; flex-direction: column; justify-content: flex-start; 
    }

    /* --- Prateleira Row --- */
    .shelf-row {
        display: flex; align-items: center; margin-bottom: 5px; padding-right: 5px; flex-shrink: 0;
    }

    .shelf-controls {
        display: flex; flex-direction: column; gap: 2px; width: 24px; margin-left: 4px;
    }

    .ctrl-btn {
        border: none; border-radius: 3px; color: white; font-size: 10px;
        height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    .btn-clean { background: #f39c12; } 
    .btn-remove-shelf { background: #c0392b; } 

    /* --- A Prateleira em si --- */
    .shelf {
        flex: 1; 
        background: #fff;
        border-bottom: 8px solid var(--shelf-border); 
        border-top: 1px solid #eee;
        height: 70px; 
        display: flex; align-items: flex-end; 
        padding: 0 2px; margin-left: 5px; position: relative;
        flex-wrap: wrap; overflow: hidden; align-content: flex-end;
    }
    
    .shelf::before {
        content: ''; position: absolute; top:0; left:0; right:0; height: 15px;
        background: linear-gradient(to bottom, rgba(0,0,0,0.05), transparent);
        pointer-events: none;
    }

    /* Bot√£o Add Prateleira */
    .btn-add-shelf-wrapper {
        padding: 8px; 
        border-top: 1px solid #eee; 
        text-align: center; 
        background: #f9f9f9;
        flex: 0 0 auto; 
    }
    .btn-add-shelf {
        background: #27ae60; color: white; border: none;
        width: 95%; padding: 8px; border-radius: 4px;
        font-weight: bold; font-size: 12px; cursor: pointer;
    }

    /* --- Produtos --- */
    .product {
        margin: 0 1px 1px 1px; border-radius: 3px;
        display: flex; align-items: center; justify-content: center;
        flex-shrink: 0; position: relative;
        box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        cursor: pointer; font-size: 9px; line-height: 1;
        text-align: center; color: #fff; overflow: hidden;
        border: 1px solid rgba(255,255,255,0.3); user-select: none;
    }
    .prod-label { pointer-events: none; padding:1px; text-shadow: 0 1px 1px rgba(0,0,0,0.5);}

    /* Classes de Tamanho */
    .sz-padrao   { width: 45px; height: 45px; } 
    .sz-fino     { width: 25px; height: 50px; } 
    .sz-largo    { width: 70px; height: 40px; } 
    .sz-garrafa  { width: 30px; height: 65px; border-radius: 10px 10px 3px 3px; } 
    .sz-grande   { width: 60px; height: 60px; } 
    .sz-baixo    { width: 50px; height: 25px; } 
    .sz-longa    { width: 50px; height: 60px; } 
    .sz-blister  { width: 80px; height: 20px; } 

    /* --- Paleta Fixa (Rodap√©) --- */
    #palette-container {
        background: #fff; 
        border-top: 2px solid #ccc;
        display: flex; flex-direction: column; 
        z-index: 100;
        box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
        flex: 0 0 auto; 
        padding-bottom: env(safe-area-inset-bottom); 
        min-height: 130px;
    }
    .palette-header {
        padding: 8px 15px; background: #f4f4f4; font-size: 12px; color: #555;
        display: flex; justify-content: space-between; align-items: center;
        border-bottom: 1px solid #e0e0e0;
    }
    .btn-add-type {
        background: var(--accent); color: white; border: none; border-radius: 20px;
        padding: 6px 14px; font-size: 12px; font-weight: bold;
    }

    #palette-scroll {
        flex: 1; overflow-x: auto; display: flex; align-items: center; gap: 12px; padding: 10px 15px;
    }
    #palette-scroll .product { 
        flex-shrink: 0; margin-bottom: 0; transform: scale(0.9);
    }

    /* --- Modais --- */
    .modal-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.6);
        display: none; justify-content: center; align-items: center; z-index: 2000;
        backdrop-filter: blur(2px);
    }
    .modal-box {
        background: #fff; padding: 20px; border-radius: 8px; width: 90%; max-width: 320px;
        text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    .modal-box h3 { margin-top: 0; color: var(--primary); }
    .modal-box input, .modal-box select { 
        width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #bdc3c7; border-radius: 5px; font-size: 14px; 
    }
    .modal-btns { display: flex; gap: 10px; justify-content: center; margin-top: 15px;}
    .modal-btns button { flex:1; padding: 10px; border: none; border-radius: 5px; cursor: pointer; color:#fff; font-weight: bold;}
    
    .ghost { opacity: 0.4; background: #bdc3c7 !important; }

    /* Estilo para avisos (durante a captura de tela) */
    .capture-message {
        position: fixed; top: 0; left: 0; width: 100%; padding: 10px;
        background: #007bff; color: white; text-align: center; font-weight: bold;
        z-index: 9999; display: none;
    }
</style>
</head>
<body>

<div id="capture-message" class="capture-message">Preparando o Planograma... Aguarde.</div>

<header>
    <h1>
        Planograma
        <span class="credits">por: Lucas Coelho, 2025</span>
    </h1>
    <div class="header-btns">
        <button onclick="capturePlanogram()" style="background:#007bff">üì∏ Salvar Imagem (Print)</button>
        <button onclick="addGondola()">+ M√≥dulo</button>
        <button onclick="resetPlanogram()" style="background:#c0392b">Reset</button>
    </div>
</header>

<div id="aisle-container"></div>

<div id="palette-container">
    <div class="palette-header">
        <span>Itens Prontos (Arraste)</span>
        <button class="btn-add-type" onclick="openNewTypeModal()">+ Criar</button>
    </div>
    <div id="palette-scroll"></div>
</div>

<div id="modalEdit" class="modal-overlay">
    <div class="modal-box">
        <h3>Editar Produto</h3>
        <input type="text" id="editName" placeholder="Nome do produto">
        <div class="modal-btns">
            <button style="background:#e74c3c" onclick="deleteItem()">Remover 1</button>
            <button style="background:#34495e" onclick="saveItem()">Salvar Nome</button>
        </div>
        <button style="background:#95a5a6; width:100%; margin-top:10px; padding:8px; border:none; border-radius:4px; color:#fff" onclick="closeModals()">Cancelar</button>
    </div>
</div>

<div id="modalNew" class="modal-overlay">
    <div class="modal-box">
        <h3>Criar Novo Item</h3>
        <input type="text" id="newTypeName" placeholder="Nome (ex: Wafer)">
        <label style="text-align:left; display:block; font-size:12px; color:#666; margin-top:5px">Formato:</label>
        <select id="newTypeSize">
            <option value="sz-padrao">Padr√£o (Ex: Caixa de Leite)</option>
            <option value="sz-fino">Fino (Ex: Pasta de dente)</option>
            <option value="sz-largo">Largo (Ex: Wafer/Arroz deitado)</option>
            <option value="sz-garrafa">Garrafa / Spray</option>
            <option value="sz-baixo">Baixo (Ex: Lata/Sabonete)</option>
            <option value="sz-grande">Grande (Ex: Cereal/Sab√£o p√≥)</option>
            <option value="sz-longa">Longa (Ex: Macarr√£o)</option>
            <option value="sz-blister">Blister (Ex: Pilhas/Chiclete)</option>
        </select>
        <label style="text-align:left; display:block; font-size:12px; color:#666; margin-top:5px">Cor:</label>
        <input type="color" id="newTypeColor" value="#9b59b6" style="height:40px; padding:2px">
        <div class="modal-btns">
            <button style="background:#27ae60" onclick="createNewType()">Criar</button>
            <button style="background:#95a5a6" onclick="closeModals()">Cancelar</button>
        </div>
    </div>
</div>

<script>
    const aisle = document.getElementById('aisle-container');
    const paletteScroll = document.getElementById('palette-scroll');
    const captureMessage = document.getElementById('capture-message');
    let currentItem = null;

    // Defini√ß√£o da paleta inicial (20 itens gen√©ricos)
    const initialPaletteItems = [
        { name: "Item 1", color: "#c0392b", size: "sz-garrafa" },
        { name: "Item 2", color: "#e74c3c", size: "sz-padrao" },
        { name: "Item 3", color: "#3498db", size: "sz-garrafa" },
        { name: "Item 4", color: "#8e44ad", size: "sz-garrafa" },
        { name: "Item 5", color: "#f39c12", size: "sz-baixo" },
        { name: "Item 6", color: "#2980b9", size: "sz-padrao" },
        { name: "Item 7", color: "#f1c40f", size: "sz-grande" },
        { name: "Item 8", color: "#7f8c8d", size: "sz-padrao" },
        { name: "Item 9", color: "#d35400", size: "sz-longa" },
        { name: "Item 10", color: "#2ecc71", size: "sz-garrafa" },
        { name: "Item 11", color: "#95a5a6", size: "sz-largo" },
        { name: "Item 12", color: "#bdc3c7", size: "sz-fino" },
        { name: "Item 13", color: "#e67e22", size: "sz-largo" },
        { name: "Item 14", color: "#e91e63", size: "sz-largo" },
        { name: "Item 15", color: "#9b59b6", size: "sz-padrao" },
        { name: "Item 16", color: "#27ae60", size: "sz-fino" },
        { name: "Item 17", color: "#1abc9c", size: "sz-fino" },
        { name: "Item 18", color: "#16a085", size: "sz-baixo" },
        { name: "Item 19", color: "#34495e", size: "sz-grande" },
        { name: "Item 20", color: "#5dade2", size: "sz-garrafa" }
    ];

    new Sortable(paletteScroll, {
        group: { name: 'shared', pull: 'clone', put: false },
        sort: false, animation: 150
    });

    loadData();

    function loadData() {
        const savedPalette = localStorage.getItem('proPalette');
        paletteScroll.innerHTML = ''; 

        let currentPalette = [];
        if (savedPalette) {
            currentPalette = JSON.parse(savedPalette);
        }
        
        if (currentPalette.length === 0) {
            currentPalette = initialPaletteItems;
            localStorage.setItem('proPalette', JSON.stringify(currentPalette));
        }

        currentPalette.forEach(p => addPaletteDom(p.name, p.color, p.size));

        const savedGondolas = localStorage.getItem('proAisleData');
        aisle.innerHTML = '';
        if(savedGondolas) {
            JSON.parse(savedGondolas).forEach(gData => createGondolaDom(gData.shelves));
        } else {
            createGondolaDom([[],[],[],[],[]]);
            createGondolaDom([[],[],[],[],[]]);
            createGondolaDom([[],[],[],[],[]]);
        }
    }

    // --- FUN√á√ÉO PRINCIPAL DE CAPTURA DE IMAGEM (CORRIGIDA) ---
    async function capturePlanogram() {
        const originalAisle = document.getElementById('aisle-container');
        const originalHeader = document.querySelector('header');
        const originalPalette = document.getElementById('palette-container');
        
        captureMessage.style.display = 'block';

        // 1. Guarda os estilos originais para restaurar depois
        const originalBodyOverflow = document.body.style.overflow;
        const originalAisleOverflowX = originalAisle.style.overflowX;
        const originalAisleWidth = originalAisle.style.width;

        // 2. Prepara o layout para a captura (for√ßa a largura m√°xima)
        originalHeader.style.display = 'none'; // Esconde o cabe√ßalho
        originalPalette.style.display = 'none'; // Esconde a paleta
        document.body.style.overflow = 'hidden'; // Evita scroll do corpo
        
        // Faz o cont√™iner de m√≥dulos se expandir para a largura total do conte√∫do
        originalAisle.style.overflowX = 'visible'; 
        originalAisle.style.width = originalAisle.scrollWidth + 'px'; 
        
        // 3. Aguarda um momento para a renderiza√ß√£o acontecer
        await new Promise(r => setTimeout(r, 50)); 

        // 4. Captura
        const totalWidth = originalAisle.scrollWidth;
        const totalHeight = originalAisle.clientHeight;

        html2canvas(originalAisle, { 
            scale: 2, // Aumenta a resolu√ß√£o
            width: totalWidth,
            height: totalHeight
        }).then(canvas => {
            // 5. Cria o download
            const imageURL = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = imageURL;
            a.download = `planograma_${new Date().toISOString().slice(0, 10)}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            // 6. Restaura os estilos originais
            originalHeader.style.display = '';
            originalPalette.style.display = '';
            document.body.style.overflow = originalBodyOverflow;
            originalAisle.style.overflowX = originalAisleOverflowX;
            originalAisle.style.width = originalAisleWidth; 
            
            captureMessage.style.display = 'none';
            alert("A imagem do planograma foi gerada e est√° pronta para download ou visualiza√ß√£o na sua galeria/pasta de downloads!");
        }).catch(error => {
            // 6. Restaura os estilos originais em caso de erro
            originalHeader.style.display = '';
            originalPalette.style.display = '';
            document.body.style.overflow = originalBodyOverflow;
            originalAisle.style.overflowX = originalAisleOverflowX;
            originalAisle.style.width = originalAisleWidth; 
            
            captureMessage.style.display = 'none';
            alert("Erro ao salvar a imagem: " + error.message);
        });
    }

    // --- OUTRAS FUN√á√ïES (MANTIDAS) ---

    function addGondola() {
        createGondolaDom([[],[],[],[],[]]);
        saveState();
        setTimeout(() => aisle.scrollTo({ left: aisle.scrollWidth, behavior: 'smooth' }), 100);
    }

    function createGondolaDom(shelvesData) {
        // Corre√ß√£o para o nome dos m√≥dulos (re-indexa ap√≥s uma exclus√£o)
        const currentGondolas = document.querySelectorAll('.gondola');
        const nextId = currentGondolas.length + 1;
        
        const div = document.createElement('div');
        div.className = 'gondola';
        
        // Usa o ID tempor√°rio (nextId) no cabe√ßalho. O nome ser√° ajustado na pr√≥xima fun√ß√£o.
        div.innerHTML = `
            <div class="gondola-header">M√≥dulo ${nextId} <button class="btn-del-gondola" onclick="removeGondola(this)">√ó</button></div>
            <div class="shelf-area"></div>
            <div class="btn-add-shelf-wrapper"><button class="btn-add-shelf" onclick="addShelfToGondola(this)">+ Prateleira</button></div>
        `;
        
        const shelfArea = div.querySelector('.shelf-area');
        shelvesData.forEach(items => {
            shelfArea.appendChild(createShelfRowDom(items));
        });
        
        aisle.appendChild(div);
        updateGondolaHeaders(); // Chama para re-indexar imediatamente (se precisar)
    }
    
    // Novo: Garante que os M√≥dulos sejam renumerados corretamente
    function updateGondolaHeaders() {
        document.querySelectorAll('.gondola').forEach((gondola, index) => {
            gondola.querySelector('.gondola-header').firstChild.textContent = `M√≥dulo ${index + 1} `;
        });
    }


    function removeGondola(btn) {
        if(confirm("Remover este m√≥dulo inteiro?")) {
            btn.closest('.gondola').remove();
            updateGondolaHeaders(); // Renumera ap√≥s a remo√ß√£o
            saveState();
        }
    }

    function createShelfRowDom(items = []) {
        const row = document.createElement('div');
        row.className = 'shelf-row';
        const shelf = document.createElement('div');
        shelf.className = 'shelf';
        items.forEach(i => shelf.appendChild(createProductDom(i.name, i.color, i.size)));
        
        const controls = document.createElement('div');
        controls.className = 'shelf-controls';
        controls.innerHTML = `
            <button class="ctrl-btn btn-clean" title="Limpar itens" onclick="clearShelfItems(this)">üßπ</button>
            <button class="ctrl-btn btn-remove-shelf" title="Remover prateleira" onclick="removeShelfRow(this)">‚úï</button>
        `;

        row.appendChild(shelf);
        row.appendChild(controls);
        setupShelfSortable(shelf);
        return row;
    }

    function addShelfToGondola(btn) {
        const area = btn.closest('.gondola').querySelector('.shelf-area');
        area.appendChild(createShelfRowDom([]));
        area.scrollTop = area.scrollHeight;
        saveState();
    }

    function removeShelfRow(btn) {
        const row = btn.closest('.shelf-row');
        if(row.querySelector('.shelf').children.length > 0 && !confirm("Essa prateleira tem itens. Remover mesmo assim?")) return;
        row.remove();
        saveState();
    }

    function clearShelfItems(btn) {
        const shelf = btn.closest('.shelf-row').querySelector('.shelf');
        if(shelf.children.length > 0 && confirm("Limpar todos os produtos desta prateleira?")) {
            shelf.innerHTML = '';
            saveState();
        }
    }

    function setupShelfSortable(shelfElement) {
        new Sortable(shelfElement, {
            group: 'shared', animation: 150, ghostClass: 'ghost',
            onAdd: async (evt) => {
                const el = evt.item;
                setupProductElement(el, el.dataset.name, el.dataset.color, el.dataset.size);
                saveState(); 
                await new Promise(r => setTimeout(r, 50)); 
                if(confirm("Preencher a prateleira toda com este item?")) fillShelf(el.parentNode, el);
            },
            onUpdate: () => saveState(), onRemove: () => saveState()
        });
    }

    function fillShelf(shelf, templateItem) {
        const shelfWidth = shelf.clientWidth; 
        const itemWidth = templateItem.offsetWidth + 2; 
        const needed = Math.floor((shelfWidth - 4) / itemWidth) - shelf.children.length;
        if(needed > 0) {
            for(let i=0; i<needed; i++) {
                const clone = templateItem.cloneNode(true);
                clone.onclick = () => openEdit(clone);
                shelf.appendChild(clone);
            }
            saveState();
        }
    }

    function createProductDom(name, color, size) {
        const el = document.createElement('div');
        setupProductElement(el, name, color, size);
        return el;
    }
    function setupProductElement(el, name, color, size) {
        el.className = `product ${size}`; el.style.background = color;
        el.dataset.name = name; el.dataset.color = color; el.dataset.size = size;
        el.innerHTML = `<span class="prod-label">${name}</span>`;
        if(!el.closest('#palette-scroll')) el.onclick = () => openEdit(el);
    }
    function addPaletteDom(name, color, size) {
        const el = createProductDom(name, color, size);
        el.onclick = null; paletteScroll.appendChild(el);
    }

    function openEdit(el) {
        currentItem = el; document.getElementById('editName').value = el.dataset.name;
        document.getElementById('modalEdit').style.display = 'flex';
    }
    function saveItem() {
        if(currentItem) {
            const newName = document.getElementById('editName').value;
            currentItem.dataset.name = newName; currentItem.querySelector('.prod-label').innerText = newName;
            saveState();
        } closeModals();
    }
    function deleteItem() { if(currentItem) currentItem.remove(); saveState(); closeModals(); }
    function openNewTypeModal() {
        document.getElementById('newTypeName').value = ''; document.getElementById('modalNew').style.display = 'flex';
    }
    function createNewType() {
        const name = document.getElementById('newTypeName').value || 'Item Personalizado';
        const color = document.getElementById('newTypeColor').value;
        const size = document.getElementById('newTypeSize').value;
        addPaletteDom(name, color, size);
        const current = JSON.parse(localStorage.getItem('proPalette') || '[]');
        current.push({name, color, size}); localStorage.setItem('proPalette', JSON.stringify(current));
        closeModals();
    }
    function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display='none'); currentItem = null; }

    function saveState() {
        const data = [];
        document.querySelectorAll('.gondola').forEach(g => {
            const sData = [];
            g.querySelectorAll('.shelf-row').forEach(row => { 
                const s = row.querySelector('.shelf');
                const pData = [];
                s.querySelectorAll('.product').forEach(p => pData.push({ name: p.dataset.name, color: p.dataset.color, size: p.dataset.size }));
                sData.push(pData);
            });
            data.push({ shelves: sData });
        });
        localStorage.setItem('proAisleData', JSON.stringify(data));
    }
    
    function resetPlanogram() {
        if(confirm("Deseja limpar todos os m√≥dulos do corredor E redefinir a paleta de itens para o padr√£o (Item 1, Item 2, etc.)?")) {
            localStorage.removeItem('proAisleData'); 
            localStorage.removeItem('proPalette');
            location.reload();
        }
    }
</script>
</body>
</html>
